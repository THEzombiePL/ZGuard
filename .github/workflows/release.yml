name: Release ZGuard

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    # Pomijaj commity botÃ³w, aby uniknÄ…Ä‡ pÄ™tli
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Pobiera caÅ‚Ä… historiÄ™ wraz z tagami

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Get version from plugin.yml
        id: get_version
        run: |
          FILE_PATH=""
          if [ -f "src/main/resources/plugin.yml" ]; then
            FILE_PATH="src/main/resources/plugin.yml"
          elif [ -f "plugin.yml" ]; then
            FILE_PATH="plugin.yml"
          fi

          if [ -z "$FILE_PATH" ]; then
            echo "Error: plugin.yml not found!"
            exit 1
          fi

          VERSION=$(grep "^version:" $FILE_PATH | awk '{print $2}' | tr -d '"' | tr -d "'")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG }}"
          # OdÅ›wieÅ¼amy tagi i sprawdzamy czy istnieje
          git fetch --tags
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME already exists."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME does not exist."
          fi

      - name: Update Version in README
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # Pobierz czystÄ… wersjÄ™ (np. 1.0.0-Beta-1)
          RAW_VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          # Przygotuj wersjÄ™ pod Shields.io (zamieÅ„ '-' na '--' i ' ' na '_')
          # To naprawia bÅ‚Ä…d 404 przy wersjach Beta/Alpha
          SAFE_VERSION=$(echo "$RAW_VERSION" | sed 's/-/--/g' | sed 's/ /_/g')
          
          # PodmieÅ„ link w README.md
          sed -i "s/version-.*-orange/version-${SAFE_VERSION}-orange/g" README.md || echo "No badge found"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "chore: update version in README to ${RAW_VERSION} [skip ci]"
            git push
          fi

      - name: Build with Gradle
        if: steps.check_tag.outputs.exists == 'false'
        run: ./gradlew clean shadowJar --no-daemon

      - name: Get JAR filename
        if: steps.check_tag.outputs.exists == 'false'
        id: get_jar
        run: |
          # Szukamy pliku JAR po buildzie
          JAR_FILE=$(ls build/libs/*.jar | grep -v "sources" | head -1)
          echo "JAR_FILE=${JAR_FILE}" >> $GITHUB_OUTPUT
          echo "JAR_NAME=$(basename ${JAR_FILE})" >> $GITHUB_OUTPUT

      - name: Create Release and Tag
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.get_jar.outputs.JAR_FILE }}
          tag_name: ${{ steps.get_version.outputs.TAG }}
          name: ZGuard v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ›¡ï¸ ZGuard v${{ steps.get_version.outputs.VERSION }}
            
            Zaawansowana ochrona przed VPN i Proxy dla wersji 1.8 - 1.21+.
            
            ### ğŸ› ï¸ Zmiany w tej wersji:
            - Wsparcie dla platform **Paper/Spigot** oraz **Velocity**.
            - PeÅ‚na integracja z bibliotekÄ… **ZCore**.
            - DostÄ™pne komendy: `/zguard reload`, `/zguard info`, `/zguard help`.
            
            ### ğŸ“¥ Instalacja:
            1. Pobierz `${{ steps.get_jar.outputs.JAR_NAME }}`.
            2. Upewnij siÄ™, Å¼e posiadasz zainstalowany plugin **[ZCore](https://github.com/THEzombiePL/ZCore)**.
            
            ---
            *Automatyczne wydanie - Autor: THEzombiePL*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}